<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Administration ‚Äî SkyVault</title>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <h1>SkyVault</h1>
        <span class="admin-badge">Admin</span>
      </div>
      <nav class="admin-nav">
        <a href="#dashboard" class="admin-nav-item active" data-section="dashboard">
          <span class="nav-icon">üìä</span>
          <span>Tableau de bord</span>
        </a>
        <a href="#modules" class="admin-nav-item" data-section="modules">
          <span class="nav-icon">üì¶</span>
          <span>Modules</span>
        </a>
        <a href="#orders" class="admin-nav-item" data-section="orders">
          <span class="nav-icon">üí≥</span>
          <span>Commandes</span>
        </a>
        <a href="#users" class="admin-nav-item" data-section="users">
          <span class="nav-icon">üë•</span>
          <span>Utilisateurs</span>
        </a>
        <a href="#settings" class="admin-nav-item" data-section="settings">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span>Param√®tres</span>
        </a>
      </nav>
      <div class="admin-sidebar-footer">
        <a href="../index.html" class="btn-logout">‚Üê Retour au site</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <h2 id="pageTitle">Tableau de bord</h2>
        <div class="admin-user">
          <span>Admin</span>
          <button class="btn-user">üë§</button>
        </div>
      </header>

      <div class="admin-content">
        <!-- Dashboard Section -->
        <section id="section-dashboard" class="admin-section active">
          <div class="stats-grid">
            <div class="stat-card" id="dbStatusCard">
              <div class="stat-label">Base de donn√©es</div>
              <div class="stat-value" id="dbStatus">‚è≥</div>
              <div class="stat-trend" id="dbDetails">V√©rification...</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Modules actifs</div>
              <div class="stat-value" id="statsModules">0</div>
              <div class="stat-trend">+0 ce mois</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Commandes</div>
              <div class="stat-value" id="statsOrders">0</div>
              <div class="stat-trend">+0 cette semaine</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Utilisateurs</div>
              <div class="stat-value" id="statsUsers">0</div>
              <div class="stat-trend">+0 ce mois</div>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="dashboard-card">
              <h3>Derni√®res commandes</h3>
              <div id="recentOrders" class="recent-list"></div>
            </div>
            <div class="dashboard-card">
              <h3>Activit√© r√©cente</h3>
              <div id="recentActivity" class="recent-list"></div>
            </div>
          </div>
        </section>

        <!-- Modules Section -->
        <section id="section-modules" class="admin-section">
          <div class="section-actions">
            <button class="btn-primary" id="btnAddModule">+ Ajouter un module</button>
            <input type="search" id="searchModules" placeholder="Rechercher un module..." class="search-input">
          </div>
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Cat√©gorie</th>
                  <th>Prix HT</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="modulesTableBody">
              </tbody>
            </table>
          </div>
        </section>

        <!-- Orders Section -->
        <section id="section-orders" class="admin-section">
          <div class="section-actions">
            <select id="filterOrderStatus" class="filter-select">
              <option value="">Tous les statuts</option>
              <option value="pending">En attente</option>
              <option value="completed">Compl√©t√©e</option>
              <option value="cancelled">Annul√©e</option>
            </select>
          </div>
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Client</th>
                  <th>Modules</th>
                  <th>Montant</th>
                  <th>Date</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
              </tbody>
            </table>
          </div>
        </section>

        <!-- Users Section -->
        <section id="section-users" class="admin-section">
          <div class="section-actions">
            <button class="btn-primary" id="btnAddUser">+ Ajouter un utilisateur</button>
            <input type="search" id="searchUsers" placeholder="Rechercher un utilisateur..." class="search-input">
          </div>
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Modules actifs</th>
                  <th>Inscription</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
              </tbody>
            </table>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="section-settings" class="admin-section">
          <div class="settings-grid">
            <div class="settings-card">
              <h3>Param√®tres g√©n√©raux</h3>
              <div class="form-group">
                <label>Nom du site</label>
                <input type="text" value="SkyVault" class="form-input">
              </div>
              <div class="form-group">
                <label>Email de contact</label>
                <input type="email" value="contact@skyvault.com" class="form-input">
              </div>
              <div class="form-group">
                <label>TVA (%)</label>
                <input type="number" value="20" class="form-input">
              </div>
              <button class="btn-primary">Enregistrer</button>
            </div>

            <div class="settings-card">
              <h3>Paiement</h3>
              <div class="form-group">
                <label>Cl√© API Stripe</label>
                <input type="password" placeholder="sk_test_..." class="form-input">
              </div>
              <div class="form-group">
                <label>Mode de paiement</label>
                <select class="form-input">
                  <option>Test</option>
                  <option>Production</option>
                </select>
              </div>
              <button class="btn-primary">Enregistrer</button>
            </div>

            <div class="settings-card">
              <h3>Notifications</h3>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" checked>
                  <span>Notifications par email</span>
                </label>
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" checked>
                  <span>Alertes nouvelles commandes</span>
                </label>
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox">
                  <span>Rapport hebdomadaire</span>
                </label>
              </div>
              <button class="btn-primary">Enregistrer</button>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal Add/Edit Module -->
  <div id="modalModule" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalModuleTitle">Ajouter un module</h3>
        <button class="btn-close" onclick="closeModal('modalModule')">√ó</button>
      </div>
      <div class="modal-body">
        <form id="formModule">
          <div class="form-group">
            <label>Nom du module *</label>
            <input type="text" id="moduleName" required class="form-input">
          </div>
          <div class="form-group">
            <label>Slug *</label>
            <input type="text" id="moduleSlug" required class="form-input">
          </div>
          <div class="form-group">
            <label>Description *</label>
            <textarea id="moduleDescription" rows="3" required class="form-input"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Cat√©gorie *</label>
              <select id="moduleCategory" required class="form-input">
                <option value="finance">Finance</option>
                <option value="ventes">Ventes</option>
                <option value="communication">Communication</option>
                <option value="chaine-approvisionnement">Cha√Æne approvisionnement</option>
                <option value="rh">RH</option>
                <option value="services">Services</option>
                <option value="productivite">Productivit√©</option>
              </select>
            </div>
            <div class="form-group">
              <label>Prix HT (‚Ç¨) *</label>
              <input type="number" id="modulePrice" required min="0" step="0.01" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label>Chemin *</label>
            <input type="text" id="modulePath" required class="form-input" placeholder="modules/finance/comptabilite/">
          </div>
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closeModal('modalModule')">Annuler</button>
            <button type="submit" class="btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
// Navigation entre sections
const navLinks = document.querySelectorAll('.admin-nav-item');
const sections = document.querySelectorAll('.admin-section');

navLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const target = link.getAttribute('data-section');
    
    navLinks.forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + target).classList.add('active');
    
    const title = link.textContent.trim();
    document.querySelector('.admin-header h2').textContent = title;
  });
});

// Charger les modules depuis modules.json
let modulesData = [];
async function loadModules() {
  try {
    const response = await fetch('../modules/modules.json');
    modulesData = await response.json();
    renderModulesTable();
    updateDashboardStats();
  } catch (error) {
    console.error('Erreur chargement modules:', error);
  }
}

// V√©rifier le statut de la base de donn√©es
async function checkDatabaseStatus() {
  const dbStatusCard = document.getElementById('dbStatusCard');
  const dbStatus = document.getElementById('dbStatus');
  const dbDetails = document.getElementById('dbDetails');
  
  try {
    const response = await fetch('../server/php/db-status.php');
    const data = await response.json();
    
    if (data.connected) {
      dbStatus.textContent = '‚úì Connect√©';
      dbStatusCard.style.borderLeft = '4px solid #10b981';
      dbDetails.textContent = `MySQL ${data.details.version.split('-')[0]} - ${data.details.tables} tables`;
    } else {
      dbStatus.textContent = '‚úó D√©connect√©';
      dbStatusCard.style.borderLeft = '4px solid #ef4444';
      dbDetails.textContent = data.message.substring(0, 40) + '...';
    }
  } catch (error) {
    dbStatus.textContent = '‚ö† Erreur';
    dbStatusCard.style.borderLeft = '4px solid #f59e0b';
    dbDetails.textContent = 'Impossible de v√©rifier';
    console.error('Erreur statut DB:', error);
  }
}

// Afficher les modules dans le tableau
function renderModulesTable() {
  const tbody = document.getElementById('modulesTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  
  modulesData.forEach((module, index) => {
    const status = index % 3 === 0 ? 'active' : 'inactive';
    const statusClass = status === 'active' ? 'status-active' : 'status-inactive';
    const categoryMap = {
      'rh': 'RH',
      'finance': 'Finance',
      'ventes': 'Ventes',
      'services': 'Services',
      'productivite': 'Productivit√©',
      'communication': 'Communication',
      'chaine-approvisionnement': 'Cha√Æne approvisionnement'
    };
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><strong>${module.title}</strong></td>
      <td>${categoryMap[module.slug.split('/')[0]] || 'Autre'}</td>
      <td>${module.price.toFixed(2)} ‚Ç¨</td>
      <td><span class="status-badge ${statusClass}">${status === 'active' ? 'Actif' : 'Inactif'}</span></td>
      <td class="table-actions">
        <button class="btn-icon" onclick="editModule(${index})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn-icon" onclick="deleteModule(${index})" title="Supprimer">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Stats dashboard
async function updateDashboardStats() {
  try {
    // R√©cup√©rer les stats r√©elles de la DB
    const response = await fetch('../server/php/stats.php');
    const stats = await response.json();
    
    const statsModules = document.getElementById('statsModules');
    const statsRevenue = document.getElementById('statsRevenue');
    const statsOrders = document.getElementById('statsOrders');
    const statsUsers = document.getElementById('statsUsers');
    
    if (statsModules) statsModules.textContent = stats.modules || modulesData.length;
    if (statsRevenue) statsRevenue.textContent = stats.revenue.toFixed(2) + '‚Ç¨';
    if (statsOrders) statsOrders.textContent = stats.orders;
    if (statsUsers) statsUsers.textContent = stats.users;
  } catch (error) {
    console.error('Erreur stats:', error);
    // Fallback sur les modules charg√©s
    const statsModules = document.getElementById('statsModules');
    if (statsModules) statsModules.textContent = modulesData.length;
  }
}

// Modal gestion
let editingIndex = -1;

function openModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.classList.add('active');
}

function closeModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.classList.remove('active');
  editingIndex = -1;
}

function editModule(index) {
  editingIndex = index;
  const module = modulesData[index];
  document.getElementById('modalTitle').textContent = 'Modifier le module';
  document.getElementById('moduleName').value = module.title;
  document.getElementById('moduleSlug').value = module.slug;
  document.getElementById('moduleDescription').value = module.description;
  document.getElementById('moduleCategory').value = module.slug.split('/')[0];
  document.getElementById('modulePrice').value = module.price;
  document.getElementById('modulePath').value = module.path;
  openModal('modalModule');
}

function deleteModule(index) {
  if (confirm('√ätes-vous s√ªr de vouloir supprimer ce module ?')) {
    modulesData.splice(index, 1);
    renderModulesTable();
    updateDashboardStats();
    alert('Module supprim√© (simulation)');
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Bouton ajouter module
  const btnAddModule = document.getElementById('btnAddModule');
  if (btnAddModule) {
    btnAddModule.addEventListener('click', () => {
      editingIndex = -1;
      document.getElementById('modalTitle').textContent = 'Ajouter un module';
      document.getElementById('moduleForm').reset();
      openModal('modalModule');
    });
  }

  // Formulaire module
  const moduleForm = document.getElementById('moduleForm');
  if (moduleForm) {
    moduleForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const moduleData = {
        title: document.getElementById('moduleName').value,
        slug: document.getElementById('moduleSlug').value,
        description: document.getElementById('moduleDescription').value,
        price: parseFloat(document.getElementById('modulePrice').value),
        path: document.getElementById('modulePath').value
      };
      
      if (editingIndex === -1) {
        modulesData.push(moduleData);
        alert('Module ajout√© (simulation)');
      } else {
        modulesData[editingIndex] = moduleData;
        alert('Module modifi√© (simulation)');
      }
      
      renderModulesTable();
      updateDashboardStats();
      closeModal('modalModule');
    });
  }

  // Recherche modules
  const searchModules = document.getElementById('searchModules');
  if (searchModules) {
    searchModules.addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#modulesTableBody tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
      });
    });
  }

  // Recherche utilisateurs
  const searchUsers = document.getElementById('searchUsers');
  if (searchUsers) {
    searchUsers.addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#usersTableBody tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
      });
    });
  }

  // Formulaires param√®tres
  const forms = ['generalForm', 'paymentForm', 'notifForm'];
  forms.forEach(formId => {
    const form = document.getElementById(formId);
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        alert('Param√®tres sauvegard√©s (simulation)');
      });
    }
  });

  // Fermer modals au clic sur overlay
  document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
      }
    });
  });

  // Initialisation
  loadModules();
  checkDatabaseStatus();
  setInterval(checkDatabaseStatus, 30000);
});
  </script>
</body>
</html>
