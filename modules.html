<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sélection des modules — SkyVault</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header">
    <div class="header-top">
      <a href="index.html" class="secondary">← Retour à la présentation</a>
    </div>
    <h1>Choix des modules</h1>
    <p>Sélectionnez les modules que vous souhaitez activer pour votre compte.</p>
  </header>
  <main class="container">
    <section id="catalog" class="catalog">
      <!-- Modules will be rendered here from modules/modules.json -->
      <div class="grid" id="modulesGrid"></div>
    </section>
    <aside class="summary">
      <h3>Résumé</h3>
      <ul id="selectedList"></ul>
      <div class="totals">
        <div>Montant:</div>
        <div id="total">0€ / mois</div>
      </div>
      <button id="checkout" type="button" class="primary" disabled>Procéder au paiement</button>
    </aside>
  </main>
  <script>
    // Load modules metadata and render cards dynamically
    async function loadModules(){
      try{
        const res = await fetch('modules/modules.json');
        const modules = await res.json();
        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = modules.map(m => `
          <label class="card">
            <input type="checkbox" data-price="${m.price}" data-slug="${m.slug}" />
            <div class="card-body">
              <strong>${m.title}</strong>
              <span class="muted">${m.description}</span>
              <div class="price">${m.price}€/mois</div>
              <div style="margin-top:8px"><a href="${m.path}" class="secondary" target="_blank">Voir</a></div>
            </div>
          </label>
        `).join('');
        // Rewire behavior after injection
        initSummary();
      }catch(e){
        console.error('Unable to load modules', e);
      }
    }

    function initSummary(){
      const checkboxes = document.querySelectorAll('.card input[type="checkbox"]');
      const list = document.getElementById('selectedList');
      const totalEl = document.getElementById('total');
      const checkout = document.getElementById('checkout');

      function updateSummary(){
        list.innerHTML = '';
        let total = 0;
        checkboxes.forEach(cb=>{
          if(cb.checked){
            const name = cb.closest('.card').querySelector('strong').innerText;
            const price = Number(cb.dataset.price||0);
            total += price;
            const li = document.createElement('li');
            li.textContent = `${name} — ${price}€/mois`;
            list.appendChild(li);
          }
        });
        totalEl.textContent = total + '€ / mois';
        checkout.dataset.total = total.toFixed(2);
        checkout.disabled = total === 0;
      }

      checkboxes.forEach(cb=>cb.addEventListener('change', updateSummary));
      updateSummary();

      // Rediriger vers la page de paiement en stockant les données dans sessionStorage (pas d'amount dans l'URL)
      checkout.addEventListener('click', function(){
        if(checkout.disabled) return;
        // Utiliser le total calculé (dataset mis à jour dans updateSummary) — et fallback sur recalcul
        const total = Number(checkout.dataset.total || Array.from(checkboxes).reduce((s,cb)=>s + (cb.checked?Number(cb.dataset.price||0):0),0));
        const selectedItems = Array.from(checkboxes).filter(cb=>cb.checked).map(cb=>{
          return {
            name: cb.closest('.card').querySelector('strong').innerText,
            price: Number(cb.dataset.price||0)
          };
        });
        try{
          sessionStorage.setItem('checkoutData', JSON.stringify({amount:Number(total).toFixed(2), items:selectedItems}));
        }catch(e){/* ignore */}
        // redirection sans montant dans l'URL
        location.href = 'payment.html';
      });
    }

    loadModules();
  </script>
</body>
</html>